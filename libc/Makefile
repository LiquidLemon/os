CFLAGS+=-ffreestanding -Wall -Wextra
CPPFLAGS+=-D__is_libc -Iinclude

LIBK_CFLAGS:=$(CFLAGS)
LIBK_CPPFLAGS:=$(CPPFLAGS) -D__is_libk

SOURCES:=$(shell find . -name '*.c')

TARGET:=build

LIBK_OBJS:=$(SOURCES:%.c=$(TARGET)/%.libk.o)

.PHONY: clean

all: $(TARGET)/libk.a

$(TARGET)/libk.a: $(LIBK_OBJS)
	mkdir -p $(TARGET)
	$(AR) rcs $@ $^

$(TARGET)/%.libk.o: %.c
	mkdir -p $(dir $@)
	$(CC) -MD -c $< -o $@ -std=gnu11 $(CFLAGS) $(CPPFLAGS)

$(TARGET)/%.libk.o: %.S
	mkdir -p $(dir $@)
	$(CC) -MD -c $< -o $@ $(LIBK_CFLAGS) $(LIBK_CPPFLAGS)

clean:
	rm -r build

# This makes sure to rebuild sources on changes in the header files potentially
# saving many headaches. Files with appropriate rules are generated by the -MD
# switch given to gcc.

-include $(shell find $(TARGET) -name '*.d' 2>/dev/null)
