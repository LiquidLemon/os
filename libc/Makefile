CFLAGS+=-ffreestanding -Wall -Wextra
CPPFLAGS+=-D__is_libc -Iinclude

LIBK_CFLAGS:=$(CFLAGS)
LIBK_CPPFLAGS:=$(CPPFLAGS) -D__is_libk

SOURCES:=$(shell find . -name '*.c')

TARGET:=build

LIBK_OBJS:=$(SOURCES:%.c=$(TARGET)/%.libk.o)

.PHONY: all clean install-headers install-libs

all: $(TARGET)/libk.a install

$(TARGET)/libk.a: $(LIBK_OBJS)
	mkdir -p $(dir $@)
	$(AR) rcs $@ $^

$(TARGET)/%.libk.o: %.c
	mkdir -p $(dir $@)
	$(CC) -MD -c $< -o $@ -std=gnu11 $(LIBK_CFLAGS) $(LIBK_CPPFLAGS)

$(TARGET)/%.libk.o: %.S
	mkdir -p $(dir $@)
	$(CC) -MD -c $< -o $@ $(LIBK_CFLAGS) $(LIBK_CPPFLAGS)

clean:
	rm -rf build

install: install-headers install-libs

install-headers:
	mkdir -p $(SYSROOT)$(DESTDIR)
	cp -R --preserve=timestamps include/ $(SYSROOT)$(DESTDIR)

install-libs:
	mkdir -p $(SYSROOT)$(DESTDIR)/lib
	cp $(TARGET)/libk.a $(SYSROOT)$(DESTDIR)/lib/libk.a


# This makes sure to rebuild sources on changes in the header files potentially
# saving many headaches. Files with appropriate rules are generated by the -MD
# switch given to gcc.

-include $(shell find $(TARGET) -name '*.d' 2>/dev/null)
